from tonsdk.contract import Contract
from tonsdk.boc import Cell
import time
import math

class NFTSale(Contract):
    code = 'B5EE9C7241020C01000229000114FF00F4A413F4BCF2C80B01020120020302014804050004F2300202CD06070051A03859DA89A1A601A63FF481F481F481F401A861A1F481F401F481F4006104208C92B0A0158002AB0102F7D00E8698180B8D8492F82707D201876A2686980698FFD207D207D207D006A18136000F968CA116BA4E10159C720191C1C29A0E382C92F847028A26382F970FA02698FC1080289C6C8895D7970FAE99F98FD2018202B036465800AE58FA801E78B00E78B00E78B00FD016664F6AA701B13E380718103E98FE99F9810C080901F76A0840EE6B280149828148C2FBCB87089343E903E803E903E800C14E4A848685421E845A814A41C20043232C15400F3C5807E80B2DAB25C7EC00970800975D27080AC2385D4115C20043232C15400F3C5807E80B2DAB25C7EC00408E48D0D38969C20043232C15400F3C5807E80B2DAB25C7EC01C08208417F30F4520B0016371038476514433070F006014AC001925F0BE021C0029F31104910384760102510241023F006E03AC003E3025F09840FF2F00A00CA82103B9ACA0018BEF2E1C95346C7055152C70515B1F2E1CA702082105FCC3D14218010C8CB0528CF1621FA02CB6ACB1F19CB3F27CF1627CF1618CA0027FA0217CA00C98040FB0071065044451506C8CB0015CB1F5003CF1601CF1601CF1601FA02CCC9ED540082218018C8CB052ACF1621FA02CB6ACB1F13CB3F23CF165003CF16CA0021FA02CA00C98306FB0071555006C8CB0015CB1F5003CF1601CF1601CF1601FA02CCC9ED5442E62116'

    def __init__(self, **kwargs):
        self.code = kwargs.get('code') or self.code
        kwargs["code"] = Cell.one_from_boc(self.code)
        super().__init__(**kwargs)

    def create_data_cell(self) -> Cell:
        feesCell = Cell()
        feesCell.bits.write_address(self.options["marketplace_fee_address"])
        feesCell.bits.write_grams(self.options["marketplace_fee"])
        feesCell.bits.write_address(self.options["royalty_address"])
        feesCell.bits.write_grams(self.options["royalty_amount"])
        cell = Cell()
        cell.bits.write_uint(1 if self.options["is_complete"] else 0, 1)
        cell.bits.write_uint(math.ceil(time.time()), 32)
        cell.bits.write_address(self.options["marketplace_address"])
        cell.bits.write_address(self.options["nft_address"])
        cell.bits.write_address(None)
        cell.bits.write_grams(self.options["full_price"])
        cell.refs.append(feesCell)
        return cell